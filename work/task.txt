# Phase C: .obsidian/* File Format Compatibility (Safe Read/Write)

Ensure Igne can safely read and write Obsidian settings files without corrupting them.

## Context

Obsidian stores settings in `.obsidian/*.json` files. We must:
- Preserve unknown keys (don't delete fields we don't know about)
- Support merging updates
- Handle migration of old formats to new

**Reference:** `docs/OBSIDIAN_COMPATIBILITY_AI_FIRST_ROADMAP.md` Phase C

## Goal

- All .obsidian JSON files are read safely (preserve unknown fields)
- All writes merge with existing data instead of overwriting
- Support migrations for format changes

---

## Task C1: Establish Settings IO Policy

### C1.1 Create safe JSON utilities

**File to create:** `src/utils/safeJson.ts`

**Functions to implement:**
```typescript
// Read JSON and preserve all fields
export async function readJsonSafe<T>(path: string): Promise<T | null>

// Write JSON merging with existing (preserve unknown keys)
export async function writeJsonSafe<T>(path: string, data: T, options?: {
  preserveUnknown?: boolean  // default: true
  merge?: boolean             // default: true
}): Promise<void>
```

**Success criteria:**
- [ ] safeJson.ts created with readJsonSafe and writeJsonSafe
- [ ] readJsonSafe parses JSON and returns typed object
- [ ] writeJsonSafe preserves unknown keys when preserveUnknown=true
- [ ] writeJsonSafe merges with existing file when merge=true

---

## Task C2: Update All Settings Writers

### C2.1 Find and replace unsafe JSON writes

**Files to check and update:**
- `src/stores/VaultConfigStore.ts`
- `src/stores/GlobalSettingsStore.ts`
- `src/utils/dailyNotes.ts`
- `src/utils/starredFiles.ts`
- `src/components/AppearanceSettingsTab.tsx`

**Actions:**
1. Find all `invoke('write_file', { path, content: JSON.stringify(data) })`
2. Replace with `writeJsonSafe(path, data)`
3. Find all direct JSON reads
4. Replace with `readJsonSafe` where appropriate

**Success criteria:**
- [ ] No direct JSON.stringify writes to .obsidian/*
- [ ] All settings writes use writeJsonSafe
- [ ] Unknown keys are preserved

---

## Task C3: Add Migrations

### C3.1 Create migration system

**File to create:** `src/utils/settingsMigrations.ts`

**Implement:**
```typescript
export interface Migration {
  version: string
  description: string
  migrate: (data: any) => any
}

export function applyMigrations(file: string, migrations: Migration[]): void
```

### C3.2 Add example migrations

**Example:** appearance.json theme field migration
- Old: `theme: "moonstone"`
- New: `baseTheme: "obsidian", cssTheme: "moonstone"`

**Success criteria:**
- [ ] Migration system created
- [ ] Migrations run before settings are used
- [ ] Each migration is versioned and documented
- [ ] Example migration for appearance.json

---

## Task C4: Document Supported Files

### C4.1 Create settings documentation

**File to create:** `docs/OBSIDIAN_SETTINGS_FORMAT.md`

**Document:**
- app.json format and supported fields
- appearance.json format and migrations
- workspace.json format
- community-plugins.json format
- hotkeys.json format
- Which fields are Igne-only vs Obsidian-compatible

**Success criteria:**
- [ ] docs/OBSIDIAN_SETTINGS_FORMAT.md created
- [ ] All 5 settings files documented
- [ ] Migrations documented
- [ ] Unknown key preservation policy documented

---

## Task C5: Add Tests for Settings IO

### C5.1 Create safe JSON tests

**File to create:** `src/utils/__tests__/safeJson.test.ts`

**Test coverage:**
- [ ] readJsonSafe parses valid JSON
- [ ] readJsonSafe returns null for missing/invalid files
- [ ] writeJsonSafe preserves unknown keys
- [ ] writeJsonSafe merges with existing data
- [ ] Migration system applies migrations in order

**File to create:** `src/utils/__tests__/settingsMigrations.test.ts`

**Test coverage:**
- [ ] Migration applies correctly
- [ ] Multiple migrations run in sequence
- [ ] Migration doesn't affect other fields

**Success criteria:**
- [ ] All tests pass
- [ ] Coverage for safe JSON operations
- [ ] Coverage for migrations

---

## Completion

When ALL tasks complete and tests pass, add this exact marker on its own line:

PROMISE_COMPLETE_TAG
