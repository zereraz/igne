# Phase A: Lock Baseline (Compatibility Contract)

Pin Obsidian API to version 1.11.4 and enforce compatibility gate.

## Context

We need to establish which Obsidian API version we're targeting and prevent plugins that require newer versions from being installed.

**Reference:** `docs/OBSIDIAN_COMPATIBILITY_AI_FIRST_ROADMAP.md` Phase A

## Goal

- Vendor the obsidian.d.ts snapshot for 1.11.4
- Implement compatibility gate (block plugins with minAppVersion > 1.11.4)
- Support versions.json fallback for plugin installation

---

## Task A1: Vendor Baseline API Snapshot

### A1.1 Add vendored obsidian.d.ts

**Directory to create:** `compat/obsidian-api/`

**Actions:**
1. Create `compat/obsidian-api/obsidian.d.ts` with Obsidian 1.11.4 types
2. Create `compat/obsidian-api/metadata.json`:
   ```json
   {
     "obsidianNpmVersion": "1.11.4",
     "upstreamCommitSha": "<commit>",
     "upstreamBlobSha": "<blob>",
     "pinnedAtUtc": "2026-01-13T00:00:00Z"
   }
   ```

**Success criteria:**
- [ ] compat/obsidian-api/obsidian.d.ts created
- [ ] compat/obsidian-api/metadata.json created with version info
- [ ] Types reference the pinned 1.11.4 baseline

---

## Task A2: Build Compat Gate Utility

### A2.1 Implement semver compare

**File to create:** `src/utils/semver.ts`

Implement semver comparison:
```typescript
export function compareVersions(a: string, b: string): number
// Returns: -1 if a < b, 0 if equal, 1 if a > b
```

### A2.2 Wire into plugin loading

**File to modify:** `src/components/PluginsTab.tsx` or plugin manager

**Actions:**
1. Check plugin manifest.minAppVersion
2. Block if minAppVersion > "1.11.4"
3. Show user-friendly error message

**Success criteria:**
- [ ] semver.ts created with compareVersions
- [ ] Plugin with minAppVersion "1.11.5" is blocked
- [ ] Plugin with minAppVersion "1.11.4" passes gate
- [ ] User sees why plugin was blocked

---

## Task A3: Mirror versions.json Fallback

### A3.1 Implement version selection from versions.json

**Context:** When installing from plugin repo, if latest requires > 1.11.4, find newest compatible version.

**File to create or modify:** `src/utils/pluginVersionResolver.ts`

**Actions:**
1. Fetch versions.json from plugin repo
2. Find newest version with minAppVersion <= 1.11.4
3. Return selected version or null if none compatible

**Success criteria:**
- [ ] Can parse versions.json format
- [ ] Selects newest compatible version
- [ ] Returns null if no compatible version found
- [ ] UI shows which version was selected and why

---

## Completion

When ALL tasks complete, add this exact marker on its own line:

PROMISE_COMPLETE_TAG
