# Phase E: Obsidian API Layer (Pinned 1.11.4)

Build the Obsidian compatibility layer **on top of** the command/tool layer from Phase D.

## Context

Currently, `src/obsidian/*` has issues:
- **PluginManifest**: All fields are required, but upstream has optional fields
- **Vault**: Creates plain objects instead of real class instances (`instanceof` checks fail)
- **DataAdapter**: Calls non-existent backend commands (`get_file_meta`), wrong types

**Goal:** Make the Obsidian API work correctly by using the tool layer from Phase D.

**Reference:** `docs/OBSIDIAN_COMPATIBILITY_AI_FIRST_ROADMAP.md` Phase E

---

## Task E1: Fix PluginManifest Types

### E1.1 Make PluginManifest match upstream Obsidian 1.11.4

**Problem:** Current `PluginManifest` has all fields required, breaking plugins that omit optional fields.

**Upstream reference:**
```typescript
interface PluginManifest {
  id: string;
  name: string;
  version: string;
  minAppVersion: string;
  description?: string;        // OPTIONAL
  author?: string;             // OPTIONAL
  authorUrl?: string;          // OPTIONAL
  isDesktopOnly?: boolean;     // OPTIONAL
}
```

**File to modify:** `src/obsidian/types.ts` (lines 157-166)

**Action:**
- Mark `description`, `author`, `authorUrl`, `isDesktopOnly` as optional
- Add JSDoc comment referencing Obsidian 1.11.4

**Success criteria:**
- [ ] PluginManifest has 4 required fields (id, name, version, minAppVersion)
- [ ] PluginManifest has 4 optional fields (description, author, authorUrl, isDesktopOnly)
- [ ] Code compiles without errors

---

## Task E2: Fix Vault Class Instances

### E2.1 Make TFile and TFolder real class instances

**Problem:** `Vault.ts` creates plain objects and casts them as `TFile`/`TFolder`. This breaks `instanceof` checks that plugins rely on.

**Files to modify:** `src/obsidian/types.ts`, `src/obsidian/Vault.ts`

**Actions:**

1. **In `types.ts`**: Ensure `TFile` and `TFolder` are proper classes with constructors
2. **In `Vault.ts`**: Use `new TFile(...)` and `new TFolder(...)` instead of object literals

**Before (Vault.ts lines 62-74):**
```typescript
return {
  vault: this,
  path,
  name: entry.name,
  parent: parentPath ? (this.getAbstractFileByPath(parentPath) as TFolder) : null,
  stat: { ctime: 0, mtime: 0, size: 0 },
  basename: entry.name.replace(/\.[^/.]+$/, ''),
  extension: entry.name.split('.').pop() || '',
} as TFile;
```

**After:**
```typescript
return new TFile(this, path, entry.name, parentPath ? this.getAbstractFileByPath(parentPath) as TFolder : null);
```

**Success criteria:**
- [ ] `TFile` and `TFolder` have proper constructors
- [ ] `Vault.ts` uses `new TFile()` and `new TFolder()`
- [ ] `file instanceof TFile` returns `true`
- [ ] `folder instanceof TFolder` returns `true`

---

## Task E3: Fix DataAdapter

### E3.1 Fix DataAdapter backend commands

**Problem:** `DataAdapter` calls non-existent commands:
- `get_file_meta` doesn't exist (should be `stat_path`)
- `read_directory` returns `FileEntry[]`, not `string[]`

**File to modify:** `src/obsidian/DataAdapter.ts`

**Actions:**

1. **Fix `exists()` (lines 22-29):**
   - Change `get_file_meta` â†’ `stat_path`
   - Import `FileMetadata` type from backend
   - Check `exists` property

2. **Fix `list()` (lines 31-34):**
   - Change return type to `FileEntry[]`
   - Extract names from entries

**Success criteria:**
- [ ] `exists()` uses `stat_path` command
- [ ] `list()` returns array of file entry names (string[])
- [ ] Both methods handle errors correctly

---

## Task E4: Add getResourcePath to Vault

### E4.1 Implement Vault.getResourcePath()

**Problem:** Plugins call `vault.getResourcePath(file)` to get URLs for images/attachments. This method is missing.

**Reference:** Obsidian returns `app://local/<vault-path>` or similar resource URLs.

**File to modify:** `src/obsidian/Vault.ts`

**Action:** Add method that converts file path to resource URL:
```typescript
getResourcePath(file: TFile): string {
  return `app://local/${file.path}`;
}
```

**Success criteria:**
- [ ] `getResourcePath()` method added to Vault class
- [ ] Returns string in format `app://local/<path>`
- [ ] Method is typed correctly

---

## Task E5: Use Tool Layer Instead of Direct invoke

### E5.1 Refactor Vault to use tool layer

**Problem:** `Vault.ts` calls Tauri `invoke()` directly. It should use the tool layer from Phase D.

**Prerequisite:** Phase D must create `src/tools/vault.ts` first

**File to modify:** `src/obsidian/Vault.ts`

**Actions:**
1. Import tools from `src/tools/vault.ts`
2. Replace `invoke('read_file', ...)` with `tools.readFile(...)`
3. Replace `invoke('write_file', ...)` with `tools.writeFile(...)`
4. Replace `invoke('delete_file', ...)` with `tools.deleteFile(...)`
5. Replace `invoke('rename_file', ...)` with `tools.renameFile(...)`

**Success criteria:**
- [ ] All direct `invoke()` calls replaced with tool calls
- [ ] Vault uses tool layer for all file operations
- [ ] Tests still pass

---

## Task E6: Add Unit Tests for Core API

### E6.1 Create tests for Vault, MetadataCache, Workspace

**Files to create:**
- `src/obsidian/__tests__/Vault.api.test.ts`
- `src/obsidian/__tests__/MetadataCache.api.test.ts` (extend existing)

**Test coverage:**

**Vault tests:**
- [ ] `create()` creates file and triggers event
- [ ] `read()` reads file content
- [ ] `modify()` updates file and triggers event
- [ ] `delete()` removes file and triggers event
- [ ] `rename()` moves file and triggers event
- [ ] `getAbstractFileByPath()` finds files/folders
- [ ] `getResourcePath()` returns correct URL
- [ ] `instanceof` works for TFile and TFolder

**MetadataCache tests:**
- [ ] `getCache()` returns metadata for file
- [ ] `getFileCache()` returns CachedMetadata
- [ ] `getLinks()` returns links for file

**Workspace tests:**
- [ ] `getLeaf()` returns a leaf
- [ ] `activeLeaf` is accessible

**Success criteria:**
- [ ] All tests pass
- [ ] Coverage for basic Vault operations
- [ ] Coverage for basic MetadataCache operations

---

## Task E7: Implement Basic Workspace Leaf Management

### E7.1 Add Workspace leaf creation and splitting

**Problem:** Plugins need to create new panes and split views. Current `Workspace` is incomplete.

**Files to modify:** `src/obsidian/Workspace.ts`, `src/obsidian/WorkspaceLeaf.ts`

**Actions:**
1. Implement `getLeaf(newLeaf?: boolean)` - returns existing or new leaf
2. Implement `splitActiveLeaf(direction?: 'horizontal' | 'vertical')` - splits and returns new leaf
3. Ensure `activeLeaf` property is updated when leaf changes

**Success criteria:**
- [ ] `getLeaf()` returns current leaf when called without args
- [ ] `getLeaf(true)` creates and returns new leaf
- [ ] `splitActiveLeaf('vertical')` creates split
- [ ] `activeLeaf` reflects currently active leaf

---

## Task E8: Implement FileManager Behaviors

### E8.1 Wire up FileManager to use tool layer

**Problem:** `FileManager` should coordinate rename operations with link updates, using the tool layer.

**File to modify:** `src/obsidian/FileManager.ts`

**Actions:**
1. Check if FileManager exists and what it currently does
2. If it has `renameFile()`, ensure it:
   - Calls tool layer's `renameFile()`
   - Triggers MetadataCache update
   - Uses searchStore to find backlinks
3. Add trash method if not present

**Success criteria:**
- [ ] FileManager uses tool layer for operations
- [ ] Rename triggers cache updates
- [ ] Method signatures match Obsidian API

---

## Completion

When ALL tasks complete and tests pass, add this exact marker on its own line:

PROMISE_COMPLETE_TAG
