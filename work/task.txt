# Phase H: AI-First Layer (Claude-Code-like Planning + Multi-Agent)

Make AI a first-class workflow layer using the same tool/command surface.

## Context

AI should be able to:
- Plan operations with user approval
- Execute tools via the command registry
- Show diffs before applying changes
- Be audited like any other action

**Reference:** `docs/OBSIDIAN_COMPATIBILITY_AI_FIRST_ROADMAP.md` Phase H

## Goal

- AI uses command/tool layer (not direct invoke)
- Plan → approve → execute workflow
- All AI actions logged and reversible
- Optional MCP server for external tools

---

## Task H1: Agent Tool API

### H1.1 Define tool schema for agents

**File to create:** `src/agent/tools.ts`

**Define tools that map to commands:**
```typescript
export const AGENT_TOOLS = {
  // File operations
  note_read: { schema: { path: "string" }, command: "file.read" },
  note_write: { schema: { path: "string", content: "string" }, command: "file.write" },
  note_create: { schema: { path: "string", content: "string" }, command: "file.new" },
  note_rename: { schema: { oldPath: "string", newPath: "string" }, command: "file.rename" },
  
  // Search
  search_query: { schema: { query: "string" }, command: "search.query" },
  
  // Navigation
  nav_open: { schema: { path: "string" }, command: "file.open" },
  
  // Workspace
  ws_new_pane: { schema: { direction: "horizontal|vertical" }, command: "workspace.split" },
}
```

**Success criteria:**
- [ ] Agent tools defined with schemas
- [ ] Each tool maps to a command ID
- [ ] Tools can be invoked via CommandRegistry

### H1.2 Implement plan → approvals → execution loop

**File to create:** `src/agent/executor.ts`

**Implement:**
```typescript
export class AgentExecutor {
  // Agent proposes steps
  async proposePlan(steps: ProposedStep[]): Promise<Plan>
  
  // User approves (all or step-by-step)
  async approveStep(stepId: string): Promise<void>
  async approveAll(): Promise<void>
  
  // Execute approved steps via CommandRegistry
  async executeStep(stepId: string): Promise<Result>
  
  // Get diff before executing
  async getDiff(step: ProposedStep): Promise<string>
}
```

**Success criteria:**
- [ ] Can propose multi-step plan
- [ ] User can approve individual steps or all
- [ ] Each step executes via CommandRegistry
- [ ] Diffs shown before write operations
- [ ] All steps logged to audit

---

## Task H2: In-App Agent UI

### H2.1 Create Agent panel component

**File to create:** `src/components/AgentPanel.tsx`

**UI sections:**
1. Conversation (chat history)
2. Plan checklist (current step, completed, pending)
3. Tool execution log (what ran, result, duration)
4. Diff viewer (before/after for edits)

**Success criteria:**
- [ ] Agent panel shows all 4 sections
- [ ] Can approve/reject individual steps
- [ ] Can approve all steps at once
- [ ] See diff before applying changes
- [ ] Tool execution shows in real-time

### H2.2 Add scoped context controls

**File to create:** `src/components/AgentContext.tsx`

**Controls:**
- Select folders/notes to include
- Attach currently open note
- Limit to read-only mode
- Set max iterations

**Success criteria:**
- [ ] Can select folder scope
- [ ] Can attach open note
- [ ] Read-only mode prevents writes
- [ ] Max iterations enforced

---

## Task H3: Add Tests

### H3.1 Create agent tests

**File to create:** `src/agent/__tests__/executor.test.ts`

**Test coverage:**
- [ ] Plan creation from proposed steps
- [ ] Step approval workflow
- [ ] Execution via CommandRegistry
- [ ] Diff generation
- [ ] Audit logging

**Success criteria:**
- [ ] All tests pass
- [ ] Agent executor works correctly

---

## Completion

When ALL tasks complete and tests pass, add this exact marker on its own line:

PROMISE_COMPLETE_TAG
